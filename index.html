<!doctype html>
<html>
  <head>
      <script src="/scripts/pyodide.js"></script>
  </head>
  <body>
    Pyodide test page <br>
    Open your browser console to see Pyodide output

    <form id="pdfForm">
      <input type="file" id="pdfInput">
      <button type="submit">Upload PDF</button>
    </form>

    <script type="text/javascript">
      async function main(){
        let pyodide = await loadPyodide();
        await pyodide.loadPackage("micropip");
        const micropip = pyodide.pyimport("micropip");
        await micropip.install('markitdown');
        console.log(pyodide.runPython(`
            import sys
            sys.version
        `));
        pyodide.runPython("print(1 + 2)");

        document.getElementById('pdfForm').addEventListener('submit', async (event) => {
          event.preventDefault();
          const fileInput = document.getElementById('pdfInput');
          const file = fileInput.files[0];
          if (file) {
            const arrayBuffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);
            pyodide.FS.writeFile('/uploaded_file', uint8Array);
            console.log('PDF file loaded into Pyodide');
            // You can now use the PDF file in Pyodide
            // For example, you can use Pyodide to read the file and process it

            const result = pyodide.runPython(`
              from markitdown import MarkItDown
              
              markitdown = MarkItDown()
              result = markitdown.convert("/uploaded_file")
              result.text_content
            `)

            const blob = new Blob([result], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'converted.md';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            document.getElementById('pdfForm').value = '';
          }
        });
      }

      main();
    </script>
  </body>
</html>